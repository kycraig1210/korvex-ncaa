<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>KORVEX — NCAAB Betting Intelligence</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.0/dist/chartjs-plugin-annotation.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600&family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/*  ═══════════════════════════════════════════════════════════════════════
    KORVEX TERMINAL — Precision Sports Analytics
    Aesthetic: "Bloomberg Terminal meets Mission Control"
    Dark, data-dense, phosphor-green accents, monospace numerics
    ═══════════════════════════════════════════════════════════════════════ */

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root{
  --void:#060710;
  --bg:#0a0b12;
  --s1:#0f1019;
  --s2:#141520;
  --s3:#191b28;
  --s-hover:#1c1e2d;
  --edge:#1a1d2c;
  --edge-hi:#272b3e;
  --edge-focus:#363c56;
  --ink:#e0e3ee;
  --ink2:#969ab2;
  --ink3:#6a6e84;
  --ink-mute:#484c62;
  --pos:#2dd4a0;
  --pos-dim:rgba(45,212,160,.1);
  --pos-glow:rgba(45,212,160,.22);
  --neg:#f4718a;
  --neg-dim:rgba(244,113,138,.1);
  --neg-glow:rgba(244,113,138,.22);
  --warn:#f5c542;
  --warn-dim:rgba(245,197,66,.1);
  --blue:#5b9cf5;
  --blue-dim:rgba(91,156,245,.1);
  --purple:#9b7ff0;
  --orange:#f09c5b;
  --r:10px
}

html{font-size:15px;-webkit-font-smoothing:antialiased}
body{
  font-family:'Manrope',sans-serif;background:var(--bg);color:var(--ink);
  min-height:100vh;overflow-x:hidden;
  background-image:
    radial-gradient(ellipse 55% 30% at 50% -8%,rgba(45,212,160,.025),transparent),
    radial-gradient(ellipse 45% 25% at 80% 105%,rgba(91,156,245,.02),transparent);
}

::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--void)}
::-webkit-scrollbar-thumb{background:var(--edge-hi);border-radius:3px}

/* ── LOADING ───────────────────────────────────────────────────────── */
#loader{
  position:fixed;inset:0;z-index:9999;background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:1.4rem;
  transition:opacity .5s,visibility .5s;
}
#loader.done{opacity:0;visibility:hidden;pointer-events:none}
.ld-brand{
  font-family:'IBM Plex Mono',monospace;font-weight:600;font-size:1.3rem;
  letter-spacing:.18em;color:var(--pos);text-shadow:0 0 28px var(--pos-glow);
}
.ld-ring{
  width:28px;height:28px;border:2px solid var(--edge-hi);border-top-color:var(--pos);
  border-radius:50%;animation:spin .7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
.ld-msg{font-family:'IBM Plex Mono',monospace;font-size:.7rem;color:var(--ink3);letter-spacing:.05em}

/* ── ERROR ──────────────────────────────────────────────────────────── */
#errBox{
  display:none;margin:1rem 2rem 0;padding:.9rem 1.3rem;
  background:var(--neg-dim);border:1px solid rgba(244,113,138,.25);border-radius:var(--r);
  font-family:'IBM Plex Mono',monospace;font-size:.75rem;color:var(--neg);line-height:1.7;
}

/* ── HEADER ─────────────────────────────────────────────────────────── */
header{
  padding:1.4rem 2.2rem 1.1rem;border-bottom:1px solid var(--edge);
  display:flex;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;gap:.8rem;
  background:linear-gradient(180deg,rgba(45,212,160,.012),transparent);
}
.hd-brand{
  font-family:'IBM Plex Mono',monospace;font-weight:600;font-size:1.25rem;
  letter-spacing:.16em;color:var(--pos);text-shadow:0 0 26px var(--pos-glow);
}
.hd-brand em{
  font-style:normal;color:var(--ink-mute);font-weight:300;font-size:.75rem;
  letter-spacing:.08em;margin-left:.6rem;
}
.hd-sub{font-size:.7rem;color:var(--ink3);font-family:'IBM Plex Mono',monospace;letter-spacing:.04em;margin-top:.15rem}
.hd-meta{font-family:'IBM Plex Mono',monospace;font-size:.67rem;color:var(--ink-mute);text-align:right;line-height:1.7}
.hd-meta b{color:var(--ink2)}
.live-dot{
  display:inline-flex;align-items:center;gap:5px;font-size:.6rem;color:var(--pos);
  font-weight:600;letter-spacing:.07em;text-transform:uppercase;
}
.live-dot::before{
  content:'';width:5px;height:5px;border-radius:50%;background:var(--pos);
  box-shadow:0 0 7px var(--pos-glow);animation:blink 2s ease infinite;
}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* ── LAYOUT ─────────────────────────────────────────────────────────── */
.wrap{max-width:1500px;margin:0 auto;padding:1.3rem 2rem 3rem}

@keyframes rise{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.anim{opacity:0;animation:rise .4s ease forwards}

/* ── KPI CARDS ──────────────────────────────────────────────────────── */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:.8rem;margin-bottom:1.3rem}
.kpi{
  background:var(--s1);border:1px solid var(--edge);border-radius:var(--r);
  padding:1.05rem 1.2rem;position:relative;overflow:hidden;
  transition:border-color .2s,background .2s,transform .18s;
}
.kpi:hover{border-color:var(--edge-hi);background:var(--s-hover);transform:translateY(-1px)}
.kpi::after{content:'';position:absolute;top:0;left:0;right:0;height:2px;opacity:.45;transition:opacity .2s}
.kpi:hover::after{opacity:.8}
.kpi.t-pos::after{background:linear-gradient(90deg,transparent,var(--pos),transparent)}
.kpi.t-neg::after{background:linear-gradient(90deg,transparent,var(--neg),transparent)}
.kpi.t-warn::after{background:linear-gradient(90deg,transparent,var(--warn),transparent)}
.kpi.t-blue::after{background:linear-gradient(90deg,transparent,var(--blue),transparent)}
.kpi-lbl{
  font-family:'IBM Plex Mono',monospace;font-size:.58rem;font-weight:500;
  letter-spacing:.1em;text-transform:uppercase;color:var(--ink-mute);margin-bottom:.4rem;
}
.kpi-val{font-family:'IBM Plex Mono',monospace;font-size:1.55rem;font-weight:600;line-height:1.1}
.kpi-val.c-g{color:var(--pos)}.kpi-val.c-r{color:var(--neg)}.kpi-val.c-w{color:var(--warn)}
.kpi-note{
  font-family:'IBM Plex Mono',monospace;font-size:.62rem;color:var(--ink-mute);
  margin-top:.32rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.pill{display:inline-block;padding:1px 5px;border-radius:3px;font-size:.57rem;font-weight:500;margin-left:2px}
.pill-g{background:var(--pos-dim);color:var(--pos)}
.pill-r{background:var(--neg-dim);color:var(--neg)}

/* ── PANELS ─────────────────────────────────────────────────────────── */
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:.8rem;margin-bottom:.8rem}
.grid1{display:grid;grid-template-columns:1fr;gap:.8rem;margin-bottom:.8rem}
.pnl{background:var(--s1);border:1px solid var(--edge);border-radius:var(--r);padding:1.05rem 1.2rem .85rem}
.chart-box{position:relative;width:100%;height:340px}
.pnl-hd{display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem;flex-wrap:wrap;gap:.4rem}
.pnl-t{font-family:'IBM Plex Mono',monospace;font-size:.65rem;font-weight:500;letter-spacing:.07em;text-transform:uppercase;color:var(--ink2)}
.dot{display:inline-block;width:5px;height:5px;border-radius:50%;margin-right:6px;vertical-align:middle}
.d-g{background:var(--pos);box-shadow:0 0 5px var(--pos-glow)}
.d-b{background:var(--blue);box-shadow:0 0 5px rgba(91,156,245,.25)}
.d-o{background:var(--orange);box-shadow:0 0 5px rgba(240,156,91,.25)}
.d-p{background:var(--purple);box-shadow:0 0 5px rgba(155,127,240,.25)}

/* ── TABLE ──────────────────────────────────────────────────────────── */
.tbl-box{background:var(--s1);border:1px solid var(--edge);border-radius:var(--r);padding:1.05rem 1.2rem;overflow-x:auto}
table.t{width:100%;border-collapse:collapse;font-family:'IBM Plex Mono',monospace;font-size:.7rem}
table.t th{
  text-align:left;font-weight:500;color:var(--ink-mute);letter-spacing:.06em;text-transform:uppercase;
  padding:.5rem .65rem;border-bottom:1px solid var(--edge-hi);font-size:.58rem;
  position:sticky;top:0;background:var(--s1);
}
table.t th:not(:first-child){text-align:right}
table.t td{padding:.45rem .65rem;border-bottom:1px solid var(--edge);color:var(--ink2);font-variant-numeric:tabular-nums}
table.t td:not(:first-child){text-align:right}
table.t td:first-child{color:var(--ink);font-weight:400;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
table.t tr:hover td{background:rgba(45,212,160,.02)}
table.t tr:last-child td{border-bottom:none}
.vp{color:var(--pos)}.vn{color:var(--neg)}
tr.tot td{border-top:2px solid var(--edge-hi);font-weight:600;color:var(--ink)!important;padding-top:.6rem}

/* ── RESPONSIVE ─────────────────────────────────────────────────────── */
@media(max-width:1024px){
  .grid2{grid-template-columns:1fr 1fr}
  .kpi-grid{grid-template-columns:repeat(auto-fit,minmax(170px,1fr))}
  .chart-box{height:300px}
  .wrap{padding:1.1rem 1.4rem 2.5rem}
}
@media(max-width:768px){
  .grid2{grid-template-columns:1fr}
  .kpi-grid{grid-template-columns:repeat(3,1fr)}
  .chart-box{height:280px}
  .wrap{padding:1rem}
  header{padding:1.1rem 1rem .85rem;flex-direction:column;align-items:flex-start}
  .hd-meta{text-align:left}
  html{font-size:14px}
  table.t{font-size:.67rem}
  table.t th{font-size:.56rem}
  .kpi-val{font-size:1.3rem}
  .pnl-t{font-size:.6rem}
}
@media(max-width:480px){
  .kpi-grid{grid-template-columns:1fr 1fr}
  .chart-box{height:220px}
  html{font-size:13px}
  .kpi{padding:.85rem .9rem}
  .kpi-val{font-size:1.1rem}
  .kpi-lbl{font-size:.53rem}
  .kpi-note{font-size:.55rem}
  .pnl{padding:.8rem .85rem .65rem}
  .pnl-t{font-size:.57rem}
  .tbl-box{padding:.8rem .85rem}
  table.t{font-size:.6rem}
  table.t th{font-size:.5rem}
  table.t td{padding:.35rem .4rem}
  table.t th{padding:.35rem .4rem}
  table.t td:first-child{max-width:120px}
  .hd-brand{font-size:1rem}
  .hd-brand em{font-size:.65rem}
  .hd-sub{font-size:.58rem}
  .wrap{padding:.7rem}
  header{padding:.85rem .7rem .65rem}
}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loader">
  <div class="ld-brand">KORVEX</div>
  <div class="ld-ring"></div>
  <div class="ld-msg" id="ldMsg">Connecting to data source…</div>
</div>

<!-- ERROR -->
<div id="errBox"></div>

<!-- HEADER -->
<header>
  <div>
    <div class="hd-brand">KORVEX<em>SPORTS INTEL</em></div>
    <div class="hd-sub">NCAAB Spread Betting — Live Performance Dashboard</div>
  </div>
  <div class="hd-meta">
    <div class="live-dot">Auto-updating from Google Sheets</div>
    <div style="margin-top:2px">Refreshed: <b id="tsRefresh">—</b></div>
    <div id="metaWindow">—</div>
  </div>
</header>

<main class="wrap" id="main" style="display:none">
  <section class="kpi-grid" id="kpiRow"></section>

  <section class="grid2 anim" style="animation-delay:.12s">
    <div class="pnl">
      <div class="pnl-hd"><div class="pnl-t"><span class="dot d-g"></span>ROI by Bucket</div></div>
      <div class="chart-box"><canvas id="cRoiBar"></canvas></div>
    </div>
    <div class="pnl">
      <div class="pnl-hd"><div class="pnl-t"><span class="dot d-b"></span>Win % by Bucket</div></div>
      <div class="chart-box"><canvas id="cWpBar"></canvas></div>
    </div>
  </section>

  <section class="grid2 anim" style="animation-delay:.2s">
    <div class="pnl">
      <div class="pnl-hd"><div class="pnl-t"><span class="dot d-o"></span>Total Profit by Bucket</div></div>
      <div class="chart-box"><canvas id="cProfitBar"></canvas></div>
    </div>
    <div class="pnl">
      <div class="pnl-hd"><div class="pnl-t"><span class="dot d-p"></span>Cumulative Profit Over Time</div></div>
      <div class="chart-box"><canvas id="cCumLine"></canvas></div>
    </div>
  </section>

  <section class="tbl-box anim" style="animation-delay:.28s">
    <div class="pnl-hd" style="margin-bottom:.55rem">
      <div class="pnl-t"><span class="dot d-g"></span>Bucket Performance Summary</div>
    </div>
    <table class="t"><thead><tr>
      <th>Bucket</th><th>W</th><th>L</th><th>Total</th><th>Win %</th><th>ROI</th><th>Profit</th>
    </tr></thead><tbody id="tblBody"></tbody></table>
  </section>
</main>

<script>
/* ═══════════════════════════════════════════════════════════════════════════
   DATA SOURCE — Your Google Sheets published CSV link
   ═══════════════════════════════════════════════════════════════════════════ */
const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT0Hwi4t6xp8RkR6Mih7sHpkk0dbvJ9bIuAl46givUktGiCQy6UXCb73BrgdC_UjeIndiNSi9WZUv4O/pub?gid=1505757219&single=true&output=csv";

/* ═══════════════════════════════════════════════════════════════════════════
   CONSTANTS
   ═══════════════════════════════════════════════════════════════════════════ */
const WIN_PAYOUT  = 909.09;  // profit on $1000 bet at -110
const LOSS_COST   = 1000;
const BREAK_EVEN  = 52.38;

/* Ordered bucket list */
const BUCKET_ORDER = [
  "Fav -100 to -149 × 0-2 spread",
  "Fav -150 to -199 × 0-4 spread",
  "Fav -200 to -299 (all spreads)",
  "Fav -300 to -499 (all spreads)",
  "Fav -500+ (all spreads)",
  "Dog +100-199 × 2.5-4 spreads",
  "Dog +100-199 × 4.5-6 spreads",
  "Dog +300-399 (all spreads)",
  "Dog +400-499 (all spreads)",
  "Dog +500-999 (all spreads)",
  "Dog +1000+ (all spreads)",
  "Gap games (positive spread + negative ML)",
  "Fav Other",
  "Dog Other"
];

/* Chart.js global defaults */
Chart.defaults.color = "#6a6e84";
Chart.defaults.borderColor = "rgba(26,29,44,0.6)";
Chart.defaults.font.family = "'IBM Plex Mono','monospace'";
Chart.defaults.font.size = 10;
Chart.defaults.plugins.legend.display = false;
Chart.defaults.animation = { duration: 800, easing: "easeOutQuart" };
Chart.defaults.responsive = true;
Chart.defaults.maintainAspectRatio = false;

/* ═══════════════════════════════════════════════════════════════════════════
   CSV PARSER — handles quoted fields, commas inside quotes, etc.
   ═══════════════════════════════════════════════════════════════════════════ */
function parseCSV(text) {
  const rows = [];
  let i = 0;
  const len = text.length;

  while (i < len) {
    const row = [];
    while (i < len) {
      let val = "";
      if (text[i] === '"') {
        // Quoted field
        i++;
        while (i < len) {
          if (text[i] === '"') {
            if (i + 1 < len && text[i + 1] === '"') {
              val += '"'; i += 2;
            } else {
              i++; break;
            }
          } else {
            val += text[i]; i++;
          }
        }
        if (i < len && text[i] === ',') i++;
        else if (i < len && (text[i] === '\n' || text[i] === '\r')) {
          if (text[i] === '\r' && i + 1 < len && text[i + 1] === '\n') i += 2; else i++;
          row.push(val); break;
        }
      } else {
        // Unquoted field
        const start = i;
        while (i < len && text[i] !== ',' && text[i] !== '\n' && text[i] !== '\r') i++;
        val = text.substring(start, i);
        if (i < len && text[i] === ',') i++;
        else if (i < len && (text[i] === '\n' || text[i] === '\r')) {
          if (text[i] === '\r' && i + 1 < len && text[i + 1] === '\n') i += 2; else i++;
          row.push(val); break;
        } else {
          // End of text
          row.push(val); break;
        }
      }
      row.push(val);
    }
    if (row.length > 0 && !(row.length === 1 && row[0] === "")) rows.push(row);
  }
  return rows;
}

/* ═══════════════════════════════════════════════════════════════════════════
   DATA PROCESSING
   ═══════════════════════════════════════════════════════════════════════════ */
function findHeaderRow(rows) {
  for (let i = 0; i < Math.min(rows.length, 15); i++) {
    const lower = rows[i].map(c => c.trim().toLowerCase());
    if (lower.includes("date") && (lower.includes("bucket name") || lower.includes("bucket"))) return i;
  }
  return -1;
}

function parseDate(s) {
  if (!s) return null;
  s = s.trim();
  // Handle multiple date formats
  // MM/DD/YYYY, YYYY-MM-DD, YYYY-MM-DD HH:MM:SS, M/D/YYYY
  let d;
  if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
    d = new Date(s.split(" ")[0] + "T00:00:00");
  } else if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) {
    const [m, day, y] = s.split("/");
    d = new Date(+y, +m - 1, +day);
  } else {
    d = new Date(s);
  }
  return isNaN(d.getTime()) ? null : d;
}

function processData(rows) {
  const hIdx = findHeaderRow(rows);
  if (hIdx < 0) throw new Error("Could not find header row with 'Date' and 'Bucket Name' columns.");

  const headers = rows[hIdx].map(h => h.trim());
  const col = {};
  headers.forEach((h, i) => { col[h.toLowerCase()] = i; });

  const iDate   = col["date"];
  const iBucket = col["bucket name"] ?? col["bucket"];
  const iCover  = col["cover flag"] ?? col["coverflag"];
  const iSpread = col["spread"];
  const iOdds   = col["odds"];

  if (iDate === undefined || iBucket === undefined || iCover === undefined) {
    throw new Error("Missing required columns. Need: Date, Bucket Name, Cover Flag. Found: " + headers.join(", "));
  }

  const bets = [];
  for (let r = hIdx + 1; r < rows.length; r++) {
    const row = rows[r];
    if (!row || row.length < 3) continue;

    const dateStr  = row[iDate]?.trim();
    const bucket   = row[iBucket]?.trim();
    const coverRaw = row[iCover]?.trim();

    if (!dateStr || !bucket || coverRaw === "" || coverRaw === undefined) continue;

    const date = parseDate(dateStr);
    if (!date) continue;

    const cover  = parseInt(coverRaw, 10);
    if (isNaN(cover)) continue;

    const spread = iSpread !== undefined ? parseFloat(row[iSpread]) : null;
    const odds   = iOdds !== undefined ? parseFloat(row[iOdds]) : null;

    bets.push({ date, bucket, cover, spread, odds });
  }

  // Sort by date
  bets.sort((a, b) => a.date - b.date);
  return bets;
}

function computeStats(bets) {
  // Bucket summary
  const bucketMap = {};
  bets.forEach(b => {
    if (!bucketMap[b.bucket]) bucketMap[b.bucket] = { wins: 0, losses: 0 };
    if (b.cover === 1) bucketMap[b.bucket].wins++;
    else bucketMap[b.bucket].losses++;
  });

  // Order buckets
  const allBuckets = [...new Set(bets.map(b => b.bucket))];
  const ordered = BUCKET_ORDER.filter(b => allBuckets.includes(b));
  const extra = allBuckets.filter(b => !BUCKET_ORDER.includes(b)).sort();
  const buckets = [...ordered, ...extra];

  const summary = buckets.map(name => {
    const s = bucketMap[name] || { wins: 0, losses: 0 };
    const total = s.wins + s.losses;
    const winPct = total > 0 ? (s.wins / total) * 100 : 0;
    const roi = total > 0 ? ((s.wins * WIN_PAYOUT - s.losses * LOSS_COST) / (total * LOSS_COST)) * 100 : 0;
    const profit = s.wins * WIN_PAYOUT - s.losses * LOSS_COST;
    return { name, wins: s.wins, losses: s.losses, total, winPct, roi, profit };
  });

  // Totals
  const totW = summary.reduce((a, s) => a + s.wins, 0);
  const totL = summary.reduce((a, s) => a + s.losses, 0);
  const totN = totW + totL;
  const totWp = totN > 0 ? (totW / totN) * 100 : 0;
  const totRoi = totN > 0 ? ((totW * WIN_PAYOUT - totL * LOSS_COST) / (totN * LOSS_COST)) * 100 : 0;
  const totProfit = totW * WIN_PAYOUT - totL * LOSS_COST;

  const best = summary.reduce((a, b) => (b.total >= 2 && b.roi > a.roi ? b : a), { roi: -Infinity, name: "—" });
  const worst = summary.reduce((a, b) => (b.total >= 2 && b.roi < a.roi ? b : a), { roi: Infinity, name: "—" });

  // Cumulative profit by date
  const cumByDate = [];
  let running = 0;
  const dateMap = new Map();
  bets.forEach(b => {
    running += b.cover === 1 ? WIN_PAYOUT : -LOSS_COST;
    const key = b.date.toISOString().slice(0, 10);
    dateMap.set(key, running);
  });
  dateMap.forEach((v, k) => cumByDate.push({ date: k, profit: v }));

  // Date range
  const minDate = bets.length > 0 ? bets[0].date : null;
  const maxDate = bets.length > 0 ? bets[bets.length - 1].date : null;

  return { summary, buckets, totW, totL, totN, totWp, totRoi, totProfit, best, worst, cumByDate, minDate, maxDate };
}

/* ═══════════════════════════════════════════════════════════════════════════
   RENDERING
   ═══════════════════════════════════════════════════════════════════════════ */
function renderKPIs(stats) {
  const grid = document.getElementById("kpiRow");
  const cards = [
    { label: "Total Bets", value: stats.totN.toLocaleString(), cls: "t-blue", vcls: "" },
    { label: "Win %", value: stats.totWp.toFixed(1) + "%", cls: stats.totWp >= BREAK_EVEN ? "t-pos" : "t-neg", vcls: stats.totWp >= BREAK_EVEN ? "c-g" : "c-r" },
    { label: "ROI", value: (stats.totRoi >= 0 ? "+" : "") + stats.totRoi.toFixed(1) + "%", cls: stats.totRoi >= 0 ? "t-pos" : "t-neg", vcls: stats.totRoi >= 0 ? "c-g" : "c-r" },
    { label: "Total Profit", value: "$" + Math.round(stats.totProfit).toLocaleString(), cls: stats.totProfit >= 0 ? "t-pos" : "t-neg", vcls: stats.totProfit >= 0 ? "c-g" : "c-r",
      note: `${stats.totW}W – ${stats.totL}L` },
    { label: "Best ROI Bucket", value: "+" + stats.best.roi.toFixed(1) + "%", cls: "t-pos", vcls: "c-g",
      note: shortBucket(stats.best.name) },
    { label: "Worst ROI Bucket", value: stats.worst.roi.toFixed(1) + "%", cls: "t-neg", vcls: "c-r",
      note: shortBucket(stats.worst.name) }
  ];

  grid.innerHTML = cards.map((c, i) =>
    `<div class="kpi ${c.cls} anim" style="animation-delay:${i * .04}s">
       <div class="kpi-lbl">${c.label}</div>
       <div class="kpi-val ${c.vcls}">${c.value}</div>
       ${c.note ? `<div class="kpi-note">${c.note}</div>` : ""}
     </div>`
  ).join("");
}

function shortBucket(name) {
  // Compact name for KPI card display
  return name.replace("(all spreads)", "(all)").replace("positive spread + negative ML", "+spread/−ML");
}

function renderTable(stats) {
  const body = document.getElementById("tblBody");
  let html = stats.summary.map(s => {
    const wpCls = s.winPct >= BREAK_EVEN ? "vp" : "vn";
    const roiCls = s.roi >= 0 ? "vp" : "vn";
    const prCls = s.profit >= 0 ? "vp" : "vn";
    return `<tr>
      <td title="${s.name}">${s.name}</td>
      <td>${s.wins}</td><td>${s.losses}</td><td>${s.total}</td>
      <td class="${wpCls}">${s.winPct.toFixed(1)}%</td>
      <td class="${roiCls}">${s.roi >= 0 ? "+" : ""}${s.roi.toFixed(1)}%</td>
      <td class="${prCls}">$${Math.round(s.profit).toLocaleString()}</td>
    </tr>`;
  }).join("");

  // Total row
  const twcls = stats.totWp >= BREAK_EVEN ? "vp" : "vn";
  const trcls = stats.totRoi >= 0 ? "vp" : "vn";
  const tpcls = stats.totProfit >= 0 ? "vp" : "vn";
  html += `<tr class="tot">
    <td>TOTAL</td>
    <td>${stats.totW}</td><td>${stats.totL}</td><td>${stats.totN}</td>
    <td class="${twcls}">${stats.totWp.toFixed(1)}%</td>
    <td class="${trcls}">${stats.totRoi >= 0 ? "+" : ""}${stats.totRoi.toFixed(1)}%</td>
    <td class="${tpcls}">$${Math.round(stats.totProfit).toLocaleString()}</td>
  </tr>`;
  body.innerHTML = html;
}

/* ── CHART HELPERS ─────────────────────────────────────────────────── */
const C = {
  pos: "#2dd4a0", posBg: "rgba(45,212,160,0.65)",
  neg: "#f4718a", negBg: "rgba(244,113,138,0.65)",
  blue: "#5b9cf5", blueBg: "rgba(91,156,245,0.65)",
  orange: "#f09c5b", orangeBg: "rgba(240,156,91,0.65)",
  purple: "#9b7ff0", purpleBg: "rgba(155,127,240,0.65)",
  grid: "rgba(26,29,44,0.8)",
  gridLight: "rgba(40,43,62,0.5)"
};

function barColors(values, posColor, negColor) {
  return values.map(v => v >= 0 ? posColor : negColor);
}

function shortLabel(name) {
  return name
    .replace("Fav -100 to -149 × 0-2 spread", "F −100/−149")
    .replace("Fav -150 to -199 × 0-4 spread", "F −150/−199")
    .replace("Fav -200 to -299 (all spreads)", "F −200/−299")
    .replace("Fav -300 to -499 (all spreads)", "F −300/−499")
    .replace("Fav -500+ (all spreads)", "F −500+")
    .replace("Dog +100-199 × 2.5-4 spreads", "D +100/2.5–4")
    .replace("Dog +100-199 × 4.5-6 spreads", "D +100/4.5–6")
    .replace("Dog +300-399 (all spreads)", "D +300/+399")
    .replace("Dog +400-499 (all spreads)", "D +400/+499")
    .replace("Dog +500-999 (all spreads)", "D +500/+999")
    .replace("Dog +1000+ (all spreads)", "D +1000+")
    .replace("Gap games (positive spread + negative ML)", "Gap")
    .replace("Fav Other", "F Other")
    .replace("Dog Other", "D Other")
    .replace(name, name.substring(0, 14));  // fallback
}

function makeScales(yLabel, pct) {
  return {
    x: {
      grid: { color: C.grid, drawBorder: false },
      ticks: { maxRotation: 55, minRotation: 35, font: { size: 9 } }
    },
    y: {
      grid: { color: C.gridLight, drawBorder: false },
      ticks: { callback: v => pct ? v.toFixed(0) + "%" : "$" + v.toLocaleString(), font: { size: 9 } },
      title: { display: true, text: yLabel, color: "#6a6e84", font: { size: 10 } }
    }
  };
}

/* ── RENDER CHARTS ──────────────────────────────────────────────────── */
function renderCharts(stats) {
  const labels = stats.summary.map(s => shortLabel(s.name));
  const roiVals = stats.summary.map(s => +s.roi.toFixed(2));
  const wpVals = stats.summary.map(s => +s.winPct.toFixed(2));
  const profitVals = stats.summary.map(s => Math.round(s.profit));

  // ── ROI BAR ──
  new Chart(document.getElementById("cRoiBar"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        data: roiVals,
        backgroundColor: barColors(roiVals, C.posBg, C.negBg),
        borderColor: barColors(roiVals, C.pos, C.neg),
        borderWidth: 1, borderRadius: 3, maxBarThickness: 38
      }]
    },
    options: {
      scales: makeScales("ROI %", true),
      plugins: {
        tooltip: {
          callbacks: {
            title: (items) => stats.summary[items[0].dataIndex].name,
            label: (item) => "ROI: " + (item.raw >= 0 ? "+" : "") + item.raw.toFixed(1) + "%"
          }
        },
        annotation: {
          annotations: {
            zero: { type: "line", yMin: 0, yMax: 0, borderColor: "rgba(255,255,255,0.12)", borderWidth: 1, borderDash: [4, 4] }
          }
        }
      }
    }
  });

  // ── WIN % BAR ──
  new Chart(document.getElementById("cWpBar"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        data: wpVals,
        backgroundColor: wpVals.map(v => v >= BREAK_EVEN ? C.blueBg : C.negBg),
        borderColor: wpVals.map(v => v >= BREAK_EVEN ? C.blue : C.neg),
        borderWidth: 1, borderRadius: 3, maxBarThickness: 38
      }]
    },
    options: {
      scales: makeScales("Win %", true),
      plugins: {
        tooltip: {
          callbacks: {
            title: (items) => stats.summary[items[0].dataIndex].name,
            label: (item) => "Win %: " + item.raw.toFixed(1) + "%"
          }
        },
        annotation: {
          annotations: {
            breakeven: {
              type: "line", yMin: BREAK_EVEN, yMax: BREAK_EVEN,
              borderColor: "rgba(245,197,66,0.5)", borderWidth: 1.5, borderDash: [6, 3],
              label: {
                display: true, content: "Break-even 52.38%", position: "start",
                backgroundColor: "rgba(245,197,66,0.12)", color: "#f5c542",
                font: { size: 9, family: "'IBM Plex Mono'" }, padding: 3
              }
            }
          }
        }
      }
    }
  });

  // ── PROFIT BAR ──
  new Chart(document.getElementById("cProfitBar"), {
    type: "bar",
    data: {
      labels,
      datasets: [{
        data: profitVals,
        backgroundColor: barColors(profitVals, C.orangeBg, C.negBg),
        borderColor: barColors(profitVals, C.orange, C.neg),
        borderWidth: 1, borderRadius: 3, maxBarThickness: 38
      }]
    },
    options: {
      scales: makeScales("Profit ($)", false),
      plugins: {
        tooltip: {
          callbacks: {
            title: (items) => stats.summary[items[0].dataIndex].name,
            label: (item) => "Profit: $" + item.raw.toLocaleString()
          }
        },
        annotation: {
          annotations: {
            zero: { type: "line", yMin: 0, yMax: 0, borderColor: "rgba(255,255,255,0.12)", borderWidth: 1, borderDash: [4, 4] }
          }
        }
      }
    }
  });

  // ── CUMULATIVE PROFIT LINE ──
  new Chart(document.getElementById("cCumLine"), {
    type: "line",
    data: {
      labels: stats.cumByDate.map(d => d.date),
      datasets: [{
        data: stats.cumByDate.map(d => Math.round(d.profit)),
        borderColor: C.purple,
        backgroundColor: C.purpleBg.replace("0.65", "0.08"),
        fill: true,
        tension: 0.3,
        pointRadius: 2.5,
        pointBackgroundColor: C.purple,
        pointBorderColor: "transparent",
        borderWidth: 2
      }]
    },
    options: {
      scales: {
        x: {
          grid: { color: C.grid, drawBorder: false },
          ticks: { maxRotation: 40, font: { size: 9 }, maxTicksLimit: 15 }
        },
        y: {
          grid: { color: C.gridLight, drawBorder: false },
          ticks: { callback: v => "$" + v.toLocaleString(), font: { size: 9 } },
          title: { display: true, text: "Cumulative Profit ($)", color: "#6a6e84", font: { size: 10 } }
        }
      },
      plugins: {
        tooltip: {
          callbacks: { label: (item) => "Profit: $" + item.raw.toLocaleString() }
        },
        annotation: {
          annotations: {
            zero: { type: "line", yMin: 0, yMax: 0, borderColor: "rgba(255,255,255,0.1)", borderWidth: 1, borderDash: [4, 4] }
          }
        }
      }
    }
  });
}

/* ═══════════════════════════════════════════════════════════════════════════
   META
   ═══════════════════════════════════════════════════════════════════════════ */
function renderMeta(stats) {
  const now = new Date();
  document.getElementById("tsRefresh").textContent = now.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  if (stats.minDate && stats.maxDate) {
    const fmt = d => d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
    document.getElementById("metaWindow").innerHTML =
      `Window: <b>${fmt(stats.minDate)}</b> – <b>${fmt(stats.maxDate)}</b> · ${stats.totN} bets`;
  }
}

/* ═══════════════════════════════════════════════════════════════════════════
   BOOT
   ═══════════════════════════════════════════════════════════════════════════ */
async function boot() {
  const loader = document.getElementById("loader");
  const ldMsg  = document.getElementById("ldMsg");
  const errBox = document.getElementById("errBox");

  try {
    ldMsg.textContent = "Fetching live data from Google Sheets…";

    /* Try multiple fetch strategies — direct first, then CORS proxies as fallbacks */
    const strategies = [
      { name: "Direct", url: SHEET_URL },
      { name: "corsproxy.io", url: "https://corsproxy.io/?" + encodeURIComponent(SHEET_URL) },
      { name: "allorigins", url: "https://api.allorigins.win/raw?url=" + encodeURIComponent(SHEET_URL) },
      { name: "corsproxy.org", url: "https://corsproxy.org/?" + encodeURIComponent(SHEET_URL) },
    ];

    let resp = null;
    let lastErr = null;
    let usedStrategy = "";

    for (const strat of strategies) {
      try {
        ldMsg.textContent = `Trying ${strat.name}…`;
        const r = await fetch(strat.url, { signal: AbortSignal.timeout(10000) });
        if (r.ok) { resp = r; usedStrategy = strat.name; break; }
      } catch (e) { lastErr = e; }
    }

    if (!resp) throw new Error(
      "All fetch methods failed. Last error: " + (lastErr?.message || "Unknown") +
      "\\n\\nTroubleshooting:\\n• Verify the Google Sheet is published (File → Share → Publish to web → CSV)\\n• Try opening the CSV URL directly in your browser:\\n" + SHEET_URL
    );

    ldMsg.textContent = "Parsing CSV…";
    const text = await resp.text();
    const rows = parseCSV(text);

    if (rows.length < 2) throw new Error("CSV appears empty — check your published link.");

    ldMsg.textContent = "Computing analytics…";
    const bets = processData(rows);
    if (bets.length === 0) throw new Error("No valid bet rows found. Check columns: Date, Bucket Name, Cover Flag.");

    const stats = computeStats(bets);

    ldMsg.textContent = "Rendering dashboard…";
    await new Promise(r => setTimeout(r, 100)); // let the UI breathe

    document.getElementById("main").style.display = "block";
    renderKPIs(stats);
    renderTable(stats);
    renderCharts(stats);
    renderMeta(stats);

    loader.classList.add("done");
  } catch (err) {
    loader.classList.add("done");
    errBox.style.display = "block";
    errBox.innerHTML = `<strong>Data Error</strong><br>${err.message}<br><br>
      <span style="color:var(--ink3)">Make sure your Google Sheet is published to the web as CSV and the URL is correct.
      <br>Google Sheets → File → Share → Publish to web → select the correct tab → CSV → Publish</span>`;
    console.error(err);
  }
}

boot();
</script>
</body>
</html>
